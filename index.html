<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>remFS froto</title>

    <style>

      * {
        box-sizing: border-box;
      }

      body {
        background-color: #eee;
      }

      .content {
        margin: 0 auto;
        max-width: 900px;
      }

      .remfs-gallery {
        display: flex;
        flex-wrap: wrap;
      }
      
      .remfs-thumbnail {
        width: 256px;
        height: 256px;
        margin: 5px;
        background-color: #222;
      }
      .remfs-thumbnail__link {
        width: 100%;
        height: 100%;
        padding: 10px;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }
      .remfs-thumbnail__image {
        max-width: 100%;
        max-height: 100%;
      }
    </style>
  </head>

  <body>

    <div class='content'></div>

    <script src='https://cdn.jsdelivr.net/gh/remfs/remfs-auth-client@0.3.0/dist/umd.js'></script>
    <!--
    <script src='./lib/remfs-auth-client/dist/umd.js'></script>
    -->
    <script>

      (async () => {

        let urlParams = new URLSearchParams(window.location.search);

        if (urlParams.has('code') && urlParams.has('state')) {
          const result = await remfsAuthClient.completeAuthorization();
          localStorage.setItem('access_token', result.accessToken);
          
          urlParams = result.urlParams;

          console.log(result);

          urlParams.set('dir', result.state + result.perms[0].path + '/');

          history.pushState(null, '', window.location.pathname + '?' + decodeURIComponent(urlParams.toString()));
        }

        const accessToken = localStorage.getItem('access_token');

        const dirUrl = urlParams.get('dir');

        if (dirUrl) {

          const urlObj = new URL(dirUrl);
          const driveUri = urlObj.origin;
          const path = urlObj.pathname;

          let remfsUrl = dirUrl + 'remfs.json';
          if (accessToken) {
            remfsUrl += '?access_token=' + accessToken;
          }

          console.log(remfsUrl);

          const response = await fetch(remfsUrl);

          if (response.status === 200) {
            const remfs = await response.json();
            render(driveUri, path, remfs, accessToken);
          }
          else if (response.status === 403) {
            const doAuth = confirm("Unauthorized. Do you want to attempt authorization?");
            if (doAuth) {
              const trimmedPath = path.endsWith('/') ? path.slice(0, path.length - 1) : path;
              //const scope = `type=dir;perm=read;path=${trimmedPath}`;

              await remfsAuthClient.authorize({
                driveUri: driveUri,
                perms: [
                  {
                    type: 'dir',
                    perm: 'read',
                    path: trimmedPath,
                  }
                ],
                state: driveUri,
              });
            }
          }
        }
        else {
          const driveUri = prompt("Enter a remFS instance:");

          await remfsAuthClient.authorize({
            driveUri,
            perms: [
              {
                type: 'dir',
                perm: 'read',
              }
            ],
            state: driveUri,
          });
        }
      })();

      function render(driveUrl, path, remfs, accessToken) {
        const gallery = GalleryWidget(driveUrl, path, remfs, accessToken);
        const content = document.querySelector('.content');
        content.appendChild(gallery.dom);
      }

      function GalleryWidget(driveUrl, path, remfs, accessToken) {
        const dom = document.createElement('div');
        dom.classList.add('remfs-gallery');

        const items = {};

        const observeCallback = (entries, observer) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              const item = items[entry.target.dataset.filename];
              item.onVisible();
              observer.unobserve(entry.target);
            }
          });
        };

        const observeOptions = {};
        const observer = new IntersectionObserver(observeCallback, observeOptions);

        for (const filename in remfs.children) {
          const child = remfs.children[filename];
          const childPath = path + filename;

          if (isImage(filename)) {
            const image = ImageWidget(driveUrl, childPath, child, accessToken);
            items[filename] = image;
            image.dom.dataset.filename = filename;
            observer.observe(image.dom);
            dom.appendChild(image.dom);
          }
        }

        return {
          dom,
        };
      }

      function ImageWidget(driveUrl, path, remfs, accessToken) {

        const dom = document.createElement('div');
        dom.classList.add('remfs-thumbnail');

        const url = driveUrl + path;
        let thumbUrl = driveUrl + '/.remfs/images/512' + path;

        if (accessToken) {
          thumbUrl += '?access_token=' + accessToken;
        }

        const link = document.createElement('a');
        link.classList.add('remfs-thumbnail__link');
        dom.appendChild(link);
        link.setAttribute('href', url);
        link.setAttribute('target', '_blank');

        function onVisible() {
          const thumbEl = document.createElement('img');
          link.appendChild(thumbEl);
          thumbEl.classList.add('remfs-thumbnail__image');

          const thumbnailPromise = fetch(thumbUrl)
          .then(response => response.blob());

          thumbnailPromise.then(blob => {
            const url = URL.createObjectURL(blob);
            thumbEl.src = url;
          })
        }

        return {
          dom,
          onVisible,
        };
      }

      function isImage(path) {
        return path.endsWith('jpg')
          || path.endsWith('JPG')
          ;
      }

    </script>
  </body>

</html>
